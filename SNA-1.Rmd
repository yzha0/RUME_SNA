---
title: "SNA-1"
author: "Yuhao Zhao"
date: "6/2/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Preparation

## Load-in

```{r}
# Store string containing all required packages
my_packages <- c('igraph', 'RColorBrewer', 'ggplot2', 'readxl', 'Matrix')
```

Figure out which of these packages is already installed

```{r}
# Store all installed packages
ya_installed <- library()$results[,1]
# Check whether required packages are already installed and grab only those that still need installation
need_install<-my_packages[!(my_packages %in% ya_installed)]
#install required packages
lapply(need_install, install.packages, character.only = TRUE)
```

Now, load only unloaded packages

```{r}
# Store all installed packages
ya_loaded <- (.packages())
# Check whether required packages are already installed and grab only those that still need installation
need_load<-my_packages[!(my_packages %in% ya_loaded)]
# Load required packages
lapply(need_load, require, character.only = TRUE)
```

## Read-in spread sheet data

```{r}

SCORE <- read_excel("SCORENetworkData.xlsx", 
    sheet = "Total")

```

## Separate network data into corresponding time periods

```{r}

SCORE_pre <- SCORE[which(SCORE[,1]==1),]
SCORE_mid <- SCORE[which(SCORE[,1]==2),]
SCORE_Post <- SCORE[which(SCORE[,1]==3),]
```

## Build igraph objects

```{r}
SCORE.g <- graph_from_data_frame(SCORE[,2:3], directed = TRUE)
pre.g <- graph_from_data_frame(SCORE_pre[,2:3], directed = TRUE)
mid.g <- graph_from_data_frame(SCORE_mid[,2:3], directed = TRUE)
post.g <- graph_from_data_frame(SCORE_Post[,2:3], directed = TRUE)
summary(pre.g)
summary(mid.g)
summary(post.g)
```

## First glance at the structure change

```{r}
n_size <- c(gorder(pre.g), gorder(mid.g), gorder(post.g))
edge_den <- c(edge_density(pre.g), edge_density(mid.g), edge_density(post.g))
diameters <- c(diameter(pre.g), diameter(mid.g), diameter(post.g))
Sum_table<- cbind(n_size, edge_den, diameters)
View(Sum_table)
```

## Assign node attributes--role, color, size to leader teams

```{r}
PI_Index <- c("3", "8", "9", "23", "28")
V(pre.g)[V(pre.g)$name %in% PI_Index]$role <- "PI"
V(pre.g)[!(V(pre.g)$name %in% PI_Index)]$role <- "Non_PI"
V(mid.g)[V(mid.g)$name %in% PI_Index]$role <- "PI"
V(mid.g)[!(V(mid.g)$name %in% PI_Index)]$role <- "Non_PI"
V(post.g)[V(post.g)$name %in% PI_Index]$role <- "PI"
V(post.g)[!(V(post.g)$name %in% PI_Index)]$role <- "Non_PI"
V(pre.g)[V(pre.g)$role == "PI"]$shape <- "square"
V(pre.g)[V(pre.g)$role == "Non_PI"]$shape <- "circle"
V(mid.g)[V(mid.g)$role == "PI"]$shape <- "square"
V(mid.g)[V(mid.g)$role == "Non_PI"]$shape <- "circle"
V(post.g)[V(post.g)$role == "PI"]$shape <- "square"
V(post.g)[V(post.g)$role == "Non_PI"]$shape <- "circle"
```

## Plot the network graph object

```{r}
png(file="pre_summit.png", width=500, height=500)
# plot the networks
plot(pre.g,
     edge.curved  = 0.2,
     vertex.label = V(pre.g)$name
     )
#close the current plot
dev.off()

```

```{r}
png(file="mid_summit.png", width=500, height=500)
# plot the networks
plot(mid.g,
     # vertex size set to be the log of each nodes' rating category value from 1-5
     vertex.label.cex = 1,
     edge.curved  = 0.2,
     vertex.label = V(mid.g)$name
     )
#close the current plot
dev.off()

```

```{r}
png(file="post_summit.png", width=500, height=500)
# plot the networks
plot(post.g,
     edge.curved  = 0.2,
     vertex.label = V(post.g)$name,
     vertex.label.cex=2
     )
#close the current plot
dev.off()


```

## Extract the adjacent matrix

```{r}
pre_matrix <- as.matrix(get.adjacency(pre.g, sparse = FALSE))
mid_matrix <- as.matrix(get.adjacency(mid.g, sparse = FALSE))
post_matrix <- as.matrix(get.adjacency(post.g, sparse = FALSE))
View(pre_matrix)
View(mid_matrix)
View(post_matrix)
```

## Investigate edge changes

```{r}
igraph::degree(pre.g)
igraph::degree(mid.g)
igraph::degree(post.g)
```

```{r}
igraph::degree(pre.g, v=V(pre.g)[V(pre.g)$role == "PI"])
igraph::degree(mid.g, v=V(mid.g)[V(mid.g)$role == "PI"])
igraph::degree(post.g, v=V(post.g)[V(post.g)$role == "PI"])
```

```{r}
neighbors(pre.g, v="23")
neighbors(mid.g, v="23")
neighbors(post.g, v="23")

```

```{r}
adjacent_vertices(pre.g, v=V(pre.g)[V(pre.g)$role == "PI"])
adjacent_vertices(mid.g, v=V(mid.g)[V(mid.g)$role == "PI"])
adjacent_vertices(post.g, v=V(post.g)[V(post.g)$role == "PI"])
```

# Data Cleaning

## Remove vertices that didn't appear in both times

```{r}
clean_mid.g<- delete_vertices(mid.g, V(mid.g)[!(V(mid.g)$name %in% intersect(V(pre.g)$name, V(mid.g)$name))]) #group 1 pre-mid, pre not change
clean_mid2.g <- delete_vertices(mid.g, V(mid.g)[!(V(mid.g)$name %in% intersect(V(mid.g)$name, V(post.g)$name))])# group 2 mid-post
clean_post2.g <- delete_vertices(post.g, V(post.g)[!(V(post.g)$name %in% intersect(V(mid.g)$name, V(post.g)$name))]) # group 2 mid-post
clean_pre3.g <- delete_vertices(pre.g, V(pre.g)[!(V(pre.g)$name %in% intersect(V(pre.g)$name, V(post.g)$name))]) # group 3 pre-post
clean_post3.g <- delete_vertices(post.g, V(post.g)[!(V(post.g)$name %in% intersect(V(pre.g)$name, V(post.g)$name))])
```

## Return cleaned matrix(with order adjusted)

```{r}
mid1_matrix <- as.matrix(get.adjacency(clean_mid.g, sparse = FALSE))
mid1_mat<- mid1_matrix[order(as.integer(rownames(mid1_matrix))),order(as.integer(colnames(mid1_matrix)))]
pre_mat <- pre_matrix[order(as.integer(rownames(pre_matrix))),order(as.integer(colnames(pre_matrix)))]

mid2_matrix <- as.matrix(get.adjacency(clean_mid2.g, sparse = FALSE))
mid2_mat<-mid2_matrix[order(as.integer(rownames(mid2_matrix))),order(as.integer(colnames(mid2_matrix)))]

post2_matrix <-  as.matrix(get.adjacency(clean_post2.g, sparse = FALSE))
post2_mat<- post2_matrix[order(as.integer(rownames(post2_matrix))),order(as.integer(colnames(post2_matrix)))]

pre3_matrix <-as.matrix(get.adjacency(clean_pre3.g, sparse = FALSE))
pre3_mat<- pre3_matrix[order(as.integer(rownames(pre3_matrix))),order(as.integer(colnames(pre3_matrix)))]

post3_matrix <-  as.matrix(get.adjacency(clean_post3.g, sparse = FALSE))
post3_mat<- post3_matrix[order(as.integer(rownames(post3_matrix))),order(as.integer(colnames(post3_matrix)))]
```

## Calculate the difference matrix

```{r}
group1_diff<- mid1_mat-pre_mat
group2_diff<- post2_mat-mid2_mat
group3_diff <- post3_mat-pre3_mat
```

# Assign attributes

## Import participation and summit score

```{r}
SCORE_Network_Participation_De_Identified <- read_excel("~/Desktop/Research/Summer 2022 with Carrie/SCORE-SNA/SCORE Network Participation De-Identified.xlsx", 
    range = "A1:E67")
View(SCORE_Network_Participation_De_Identified)
```

## Assign new vertex attributes

### Pre-Mid

```{r}
# participation score as size of each node
V(pre.g)[as.integer(V(pre.g)$name) %in% SCORE_Network_Participation_De_Identified$id][order(as.integer(V(pre.g)[as.integer(V(pre.g)$name) %in% SCORE_Network_Participation_De_Identified$id]$name))]$size<-  SCORE_Network_Participation_De_Identified$`participation until june 21`[SCORE_Network_Participation_De_Identified$id %in% as.integer(V(pre.g)$name)]

V(clean_mid.g)[as.integer(V(clean_mid.g)$name) %in% SCORE_Network_Participation_De_Identified$id][order(as.integer(V(clean_mid.g)[as.integer(V(clean_mid.g)$name) %in% SCORE_Network_Participation_De_Identified$id]$name))]$size<- SCORE_Network_Participation_De_Identified$`participation until june 21`[SCORE_Network_Participation_De_Identified$id %in% as.integer(V(clean_mid.g)$name)]

# attending summit or not 
V(pre.g)[as.integer(V(pre.g)$name) %in% SCORE_Network_Participation_De_Identified$id][order(as.integer(V(pre.g)[as.integer(V(pre.g)$name) %in% SCORE_Network_Participation_De_Identified$id]$name))]$summit<-  SCORE_Network_Participation_De_Identified$`Summit`[SCORE_Network_Participation_De_Identified$id %in% as.integer(V(pre.g)$name)]

V(clean_mid.g)[as.integer(V(clean_mid.g)$name) %in% SCORE_Network_Participation_De_Identified$id][order(as.integer(V(clean_mid.g)[as.integer(V(clean_mid.g)$name) %in% SCORE_Network_Participation_De_Identified$id]$name))]$summit<- SCORE_Network_Participation_De_Identified$`Summit`[SCORE_Network_Participation_De_Identified$id %in% as.integer(V(clean_mid.g)$name)]

# replace na with 0
V(pre.g)$summit[is.na(V(pre.g)$summit)]<-0
V(clean_mid.g)$summit[is.na(V(clean_mid.g)$summit)]<-0

V(pre.g)$size[is.na(V(pre.g)$size)]<-0
V(clean_mid.g)$size[is.na(V(clean_mid.g)$size)]<-0

# assign color based on summit attendance
V(pre.g)[which(V(pre.g)$summit==1)]$color <- "green"
V(pre.g)[which(V(pre.g)$summit==0)]$color <- "red"

V(clean_mid.g)[which(V(clean_mid.g)$summit==1)]$color <- "green"
V(clean_mid.g)[which(V(clean_mid.g)$summit==0)]$color <- "red"
```

### Mid-Post

```{r}
# participation score as size of each node
V(clean_mid2.g)[as.integer(V(clean_mid2.g)$name) %in% SCORE_Network_Participation_De_Identified$id][order(as.integer(V(clean_mid2.g)[as.integer(V(clean_mid2.g)$name) %in% SCORE_Network_Participation_De_Identified$id]$name))]$size<-  SCORE_Network_Participation_De_Identified$`participation until june 21`[SCORE_Network_Participation_De_Identified$id %in% as.integer(V(clean_mid2.g)$name)]

V(clean_post2.g)[as.integer(V(clean_post2.g)$name) %in% SCORE_Network_Participation_De_Identified$id][order(as.integer(V(clean_post2.g)[as.integer(V(clean_post2.g)$name) %in% SCORE_Network_Participation_De_Identified$id]$name))]$size<- SCORE_Network_Participation_De_Identified$`participation until june 21`[SCORE_Network_Participation_De_Identified$id %in% as.integer(V(clean_post2.g)$name)]

# attending summit or not 
V(clean_mid2.g)[as.integer(V(clean_mid2.g)$name) %in% SCORE_Network_Participation_De_Identified$id][order(as.integer(V(clean_mid2.g)[as.integer(V(clean_mid2.g)$name) %in% SCORE_Network_Participation_De_Identified$id]$name))]$summit<-  SCORE_Network_Participation_De_Identified$`Summit`[SCORE_Network_Participation_De_Identified$id %in% as.integer(V(clean_mid2.g)$name)]

V(clean_post2.g)[as.integer(V(clean_post2.g)$name) %in% SCORE_Network_Participation_De_Identified$id][order(as.integer(V(clean_post2.g)[as.integer(V(clean_post2.g)$name) %in% SCORE_Network_Participation_De_Identified$id]$name))]$summit<- SCORE_Network_Participation_De_Identified$`Summit`[SCORE_Network_Participation_De_Identified$id %in% as.integer(V(clean_post2.g)$name)]

# replace na with 0
V(clean_mid2.g)$summit[is.na(V(clean_mid2.g)$summit)]<-0
V(clean_post2.g)$summit[is.na(V(clean_post2.g)$summit)]<-0

V(clean_mid2.g)$size[is.na(V(clean_mid2.g)$size)]<-0
V(clean_post2.g)$size[is.na(V(clean_post2.g)$size)]<-0

# assign color based on summit attendance
V(clean_mid2.g)[which(V(clean_mid2.g)$summit==1)]$color <- "green"
V(clean_mid2.g)[which(V(clean_mid2.g)$summit==0)]$color <- "red"

V(clean_post2.g)[which(V(clean_post2.g)$summit==1)]$color <- "green"
V(clean_post2.g)[which(V(clean_post2.g)$summit==0)]$color <- "red"
```

### Pre-post

```{r}
# participation score as size of each node
V(clean_pre3.g)[as.integer(V(clean_pre3.g)$name) %in% SCORE_Network_Participation_De_Identified$id][order(as.integer(V(clean_pre3.g)[as.integer(V(clean_pre3.g)$name) %in% SCORE_Network_Participation_De_Identified$id]$name))]$size<-  SCORE_Network_Participation_De_Identified$`participation until june 21`[SCORE_Network_Participation_De_Identified$id %in% as.integer(V(clean_pre3.g)$name)]

V(clean_post3.g)[as.integer(V(clean_post3.g)$name) %in% SCORE_Network_Participation_De_Identified$id][order(as.integer(V(clean_post3.g)[as.integer(V(clean_post3.g)$name) %in% SCORE_Network_Participation_De_Identified$id]$name))]$size<- SCORE_Network_Participation_De_Identified$`participation until june 21`[SCORE_Network_Participation_De_Identified$id %in% as.integer(V(clean_post3.g)$name)]

# attending summit or not 
V(clean_pre3.g)[as.integer(V(clean_pre3.g)$name) %in% SCORE_Network_Participation_De_Identified$id][order(as.integer(V(clean_pre3.g)[as.integer(V(clean_pre3.g)$name) %in% SCORE_Network_Participation_De_Identified$id]$name))]$summit<-  SCORE_Network_Participation_De_Identified$`Summit`[SCORE_Network_Participation_De_Identified$id %in% as.integer(V(clean_pre3.g)$name)]

V(clean_post3.g)[as.integer(V(clean_post3.g)$name) %in% SCORE_Network_Participation_De_Identified$id][order(as.integer(V(clean_post3.g)[as.integer(V(clean_post3.g)$name) %in% SCORE_Network_Participation_De_Identified$id]$name))]$summit<- SCORE_Network_Participation_De_Identified$`Summit`[SCORE_Network_Participation_De_Identified$id %in% as.integer(V(clean_post3.g)$name)]

# replace na with 0
V(clean_pre3.g)$summit[is.na(V(clean_pre3.g)$summit)]<-0
V(clean_post3.g)$summit[is.na(V(clean_post3.g)$summit)]<-0

V(clean_pre3.g)$size[is.na(V(clean_pre3.g)$size)]<-0
V(clean_post3.g)$size[is.na(V(clean_post3.g)$size)]<-0

# assign color based on summit attendance
V(clean_pre3.g)[which(V(clean_pre3.g)$summit==1)]$color <- "green"
V(clean_pre3.g)[which(V(clean_pre3.g)$summit==0)]$color <- "red"

V(clean_post3.g)[which(V(clean_post3.g)$summit==1)]$color <- "green"
V(clean_post3.g)[which(V(clean_post3.g)$summit==0)]$color <- "red"
```

## Adjust vertices' order

```{r}
pre_ordered.g<- permute(pre.g , invPerm(order(as.integer(V(pre.g)$name))))
clean_mid_ordered.g<- permute(clean_mid.g , invPerm(order(as.integer(V(clean_mid.g)$name))))

clean_mid2_ordered.g<- permute(clean_mid2.g , invPerm(order(as.integer(V(clean_mid2.g)$name))))
clean_post2_ordered.g<- permute(clean_post2.g , invPerm(order(as.integer(V(clean_post2.g)$name))))
  
clean_pre3_ordered.g<- permute(clean_pre3.g, invPerm(order(as.integer(V(clean_pre3.g)$name))))
clean_post3_ordered.g<- permute(clean_post3.g , invPerm(order(as.integer(V(clean_post3.g)$name))))
```

## connectance/graph density

```{r}
edge_density(pre_ordered.g)
edge_density(clean_mid_ordered.g)


edge_density(clean_mid2_ordered.g)
edge_density(clean_post2_ordered.g)

edge_density(clean_pre3_ordered.g)
edge_density(clean_post3_ordered.g)
```

# Visualize the change in networks

## Pre-Mid

```{r}
par(mfrow=c(1,2))
set.seed(1)
# save layout 
l1<- layout.fruchterman.reingold(pre_ordered.g)
plot(pre_ordered.g, vertex.label = V(pre_ordered.g)$name, vertex.label.degree=-pi/2, vertex.label.cex= 0.8,  vertex.label.dist = 1.5, vertex.label.font=2, vertex.size= 2*V(pre_ordered.g)$size+5, edge.arrow.size = 0.3, layout=l1, main="Pre[October 2019]", xlab="connectance= 0.1600529")
plot(clean_mid_ordered.g, vertex.label = V(clean_mid_ordered.g)$name, vertex.label.degree=-pi/2, vertex.label.cex= 0.8,  vertex.label.dist = 1.5, vertex.label.font=2, vertex.size= 2*V(clean_mid_ordered.g)$size+5, edge.arrow.size = 0.3, layout=l1, main="Mid[Feburary 2020]",xlab = "connectance= 0.1124339")

legend(-2, -1, legend=c("PI","attend Summit", "not attend Summit"), col = c("green","green", "red") , bty = "n", pch=c(15,20,20) , pt.cex = 2, cex = 1, text.col=c("green","green", "red") ,xjust = 0, yjust = 1, x.intersp = 1, y.intersp = 1,adj = c(0, 0.5), horiz = FALSE)
```

## Mid-Post

```{r}
par(mfrow=c(1,2))
set.seed(1)
#save layout
l2<- layout.fruchterman.reingold(clean_mid2_ordered.g)

plot(clean_mid2_ordered.g, vertex.label = V(clean_mid2_ordered.g)$name, vertex.label.degree=-pi/2, vertex.label.cex= 0.8,  vertex.label.dist = 1.5, vertex.label.font=2, vertex.size= 2*V(clean_mid2_ordered.g)$size+5, edge.arrow.size = 0.3, layout=l2, main="Mid[Feburary 2020]", xlab ="connectance= 0.2352941")
plot(clean_post2_ordered.g, vertex.label = V(clean_post2_ordered.g)$name, vertex.label.degree=-pi/2, vertex.label.cex= 0.8,  vertex.label.dist = 1.5, vertex.label.font=2, vertex.size= 2*V(clean_post2_ordered.g)$size+5, edge.arrow.size = 0.3, layout=l2, main="Post[June 2021]", xlab="connectance= 0.2647059")

legend(-2, -1, legend=c("PI", "attend Summit", "not attend Summit")  , col = c("green", "green", "red") , bty = "n", pch=20 , pt.cex = 2, cex = 1, text.col=c("green", "green", "red") ,xjust = 0, yjust = 1, x.intersp = 1, y.intersp = 1,adj = c(0, 0.5), horiz = FALSE)
```

## Pre-Post

```{r}
par(mfrow=c(1,2))
set.seed(1)
l3<- layout.fruchterman.reingold(clean_pre3_ordered.g)

plot(clean_pre3_ordered.g, vertex.label = V(clean_pre3_ordered.g)$name, vertex.label.degree=-pi/2, vertex.label.cex= 0.8,  vertex.label.dist = 1.5, vertex.size= 2*V(clean_pre3_ordered.g)$size+5, edge.arrow.size = 0.3, layout=l3, main="Pre[October 2019]", sub="connectance= 0.2904762")
plot(clean_post3_ordered.g, vertex.label = V(clean_post3_ordered.g)$name, vertex.label.degree=-pi/2, vertex.label.cex= 0.8,  vertex.label.dist = 1.5, vertex.size= 2*V(clean_post3_ordered.g)$size+5, edge.arrow.size = 0.3, layout=l3, main="Post[June 2021]", sub="connectance= 0.2809524")

legend(-1, -1, legend=c("attend summit", "not attend summit")  , col = c("green", "red") , bty = "n", pch=20 , pt.cex = 2, cex = 1, text.col=c("green", "red") ,xjust = 0, yjust = 1, x.intersp = 1, y.intersp = 1,adj = c(0, 0.5), horiz = FALSE)
```

## In-degree summary

```{r}
pre_mid_indegree<- cbind(degree(pre_ordered.g, mode = "in"), degree(clean_mid_ordered.g, mode = "in"))
colnames(pre_mid_indegree)<- c("pre", "mid")
View(pre_mid_indegree)
mid_post_indegree<- cbind(degree(clean_mid2_ordered.g, mode = "in"), degree(clean_post2_ordered.g, mode = "in"))
colnames(mid_post_indegree)<-c("mid", "post")
View(mid_post_indegree)
pre_post_indegree<- cbind(degree(clean_pre3_ordered.g, mode = "in"), degree(clean_post3_ordered.g, mode = "in"))
colnames(pre_post_indegree)<-c("pre", "post")
View(pre_post_indegree)
```

# Visualize the change of edges from Summit

## Find edge change pre-mid

```{r}
#new edges
new_pre_mid.g<-difference(clean_mid_ordered.g, pre_ordered.g)
new_E_pre_mid<- E(new_pre_mid.g)

# lost edges
lost_pre_mid.g<-difference(pre_ordered.g, clean_mid_ordered.g)
lost_E_pre_mid<- E(lost_pre_mid.g)
```

##edge change mid-post

```{r}
new_mid_post.g<-difference(clean_post2_ordered.g, clean_mid2_ordered.g)
new_E_mid_post<- E(new_mid_post.g)

lost_mid_post.g<-difference(clean_mid2_ordered.g, clean_post2_ordered.g)
lost_E_mid_post<- E(lost_mid_post.g)
```

## Assign edge attribute indicating the change

### pre-mid

```{r}

# Add new edge between pre-mid
changes_pre_mid.g<- add_edges(pre_ordered.g, c("3","24",  "3","6",  "3","4",  "7","35",  "7","27",  "7","23",  "7","4",  "8","27",  "8","4",  "9","30",  "9","4" , "9","3", "26","33", "26","23", "27","28", "27","9", "27","8",  "27","7",  "27","6", "28","27", "28","24", "35","18", "35","16", "35","9", "35","6"), color="orange")
#color the new edges
E(changes_pre_mid.g)[is.na(E(changes_pre_mid.g)$color)]$color<-"dark grey"

# dotted the lost edges
change_mat<- ends(changes_pre_mid.g, E(changes_pre_mid.g))
lost_mat<- ends(lost_pre_mid.g, E(lost_pre_mid.g))

E(changes_pre_mid.g)$lty<-1
E(changes_pre_mid.g)[c(19, 25, 35, 4, 112, 118, 96, 86, 75, 47, 42, 40, 109, 76, 60, 59, 32, 110, 33, 54, 97, 79, 108, 80, 48, 43, 1, 3, 83, 81, 61, 120, 114, 82, 78, 63, 55, 49, 8, 115, 113, 30, 9, 116, 105, 91, 88, 64, 56, 31, 18, 12, 10, 121, 99, 65, 58, 50, 21, 11, 66)]$lty<-3
```

### mid-post

```{r}
# Add new edge between mid-post
changes_mid_post.g<-add_edges(clean_mid2_ordered.g, c("2","26", "7","24", "8","37", "17","37", "17","32", "17","28", "17","16", "17","9", "17","7", "23","37", "23","28", "23","26", "23","8", "23","7", "23","4", "23","3", "24","37", "24","32", "24","28", "24","26", "24","23", "24","9", "24","8", "24","7", "24","4", "28","37", "28","8", "28","4", "37","32", "37","28", "37","17", "37","9", "37","8", "37","7"), color="orange")
E(changes_mid_post.g)[is.na(E(changes_mid_post.g)$color)]$color<-"dark grey"

# dotted the lost edges
change_mat_2<- ends(changes_mid_post.g, E(changes_mid_post.g))
E(changes_mid_post.g)$lty<-1
E(changes_mid_post.g)[c(62, 53, 64, 61, 58, 25, 22, 45, 18, 16, 32, 37, 6, 3, 49, 29, 28, 7, 43, 40, 11, 8, 42, 52, 13, 10)]$lty<-3
```

## Plot the change

### adjust node attribute

```{r}
V(changes_pre_mid.g)[which(V(changes_pre_mid.g)$name=="11")]$color<- "green"
```

```{r}
# The main title is missing
plot(changes_pre_mid.g, vertex.label = V(changes_pre_mid.g)$name, vertex.label.degree=-pi/2, vertex.label.cex= 0.8,  vertex.label.dist = 1.5, vertex.label.font=2, vertex.size= 8, edge.arrow.size = 0.3, layout=l1)
legend(0.9, 0, legend=c("PI","attend Summit", "not attend Summit", "gain collaboration", "maintain collaboration", "loss collaboration")  , col = c("green", "green", "red", "orange", "gray33", "gray33") , bty = "n", pch=c(15, 20, 20, NA, NA, NA) , lty =c(0, 0, 0, 1, 1, 2),  pt.cex = 2, cex = 1, text.col=c("green","green", "red", "orange", "gray33", "gray33") ,xjust = 0, yjust = 1, x.intersp = 1, y.intersp = 1,adj = c(0, 0.5), horiz = FALSE)
```

```{r}
plot(changes_mid_post.g, vertex.label = V(changes_mid_post.g)$name, vertex.label.degree=-pi/2, vertex.label.cex= 0.8,  vertex.label.dist = 1.5, vertex.label.font=2, vertex.size=2*V(changes_mid_post.g)$size+5 , edge.arrow.size = 0.3, layout=l2)
legend(0.95, 0, legend=c("PI","attend Summit", "not attend Summit", "gain collaboration", "maintain collaboration", "loss collaboration")  , col = c("green", "green", "red", "orange", "gray33", "gray33") , bty = "n", pch=c(15, 20, 20, NA, NA, NA) , lty =c(0, 0, 0, 1, 1, 2),  pt.cex = 2, cex = 1, text.col=c("green","green", "red", "orange", "gray33", "gray33") ,xjust = 0, yjust = 1, x.intersp = 1, y.intersp = 1,adj = c(0, 0.5), horiz = FALSE)
```

# Cluster analysis

## community detection

```{r}
c_pre<-cluster_edge_betweenness(pre.g)
c_post<-cluster_edge_betweenness(post.g)
membership(c_pre)
membership(c_post)
```

```{r}
plot(c_pre, pre.g, vertex.label=V(pre.g)$name, vertex.label.degree=-pi/2, vertex.label.cex= 0.8,  vertex.label.dist = 1.5, vertex.label.font=2, vertex.size= 8, edge.arrow.size = 0.3, layout=layout_with_fr)
```

```{r}
plot(c_post, post.g, vertex.label=V(post.g)$name, vertex.label.degree=-pi/2, vertex.label.cex= 0.8,  vertex.label.dist = 1.5, vertex.label.font=2, vertex.size= 8, edge.arrow.size = 0.3, layout=layout_with_fr)
```

## cliques of two-comparison

```{r}
sub_pre<-max_cliques(pre_ordered.g)
sub_mid<-max_cliques(clean_mid_ordered.g)

sub_mid_2<-max_cliques(clean_mid2_ordered.g)
sub_post_2<-max_cliques(clean_post2_ordered.g)

```

```{r}
graph_name<-c("pre", "mid", "mid_2", "post_2")
lrgclq<-c(clique_num(pre_ordered.g), clique_num(clean_mid_ordered.g), clique_num(clean_mid2_ordered.g), clique_num(clean_post2_ordered.g))
numclq<-c(27, 27, 13, 15)
clqinfo <- data.frame(Name= graph_name,Largest_size=lrgclq,
Number_Max_cliques=numclq)
```
